// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  ENTREPRENEUR
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum ProductType {
  PRODUCT
  SERVICE
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  email               String   @unique
  password            String?
  googleId            String?  @unique
  provider            String   @default("local")
  role                Role     @default(CUSTOMER)
  isVerified          Boolean  @default(false)
  isActive            Boolean  @default(true)
  onboardingCompleted Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  profile            Profile?
  shop               Shop?
  orders             Order[]
  reviews            Review[]
  refreshTokens      RefreshToken[]
  passwordResets     PasswordReset[]
  feedback           Feedback[]
  onboardingResponse OnboardingResponse?

  @@index([role])
}

model Profile {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  firstName String?
  lastName  String?
  phone     String?
  address   String?
  city      String?
  state     String?
  country   String   @default("Nigeria")
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @db.ObjectId
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordReset {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OnboardingResponse {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @db.ObjectId
  businessType    String
  customerSource  String
  biggestStruggle String
  paymentMethod   String
  perfectFeature  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// SHOP & SUBSCRIPTION
// ============================================

model Shop {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  ownerId     String? @unique @db.ObjectId
  name        String
  slug        String  @unique
  description String?
  logo_url    String?
  banner_url  String?
  phone       String?
  whatsapp    String?
  address     String?
  city        String?
  state       String?

  // Payment Details
  payment_method      String? @default("bank_transfer") // "paystack", "bank_transfer", or "both"
  bank_account_name   String?
  bank_name           String?
  bank_account_number String?
  paystack_public_key String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner              User?                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  products           Product[]
  orders             Order[]
  subscription       Subscription?
  RevenueTransaction RevenueTransaction[]

  @@index([isActive])
}

model Subscription {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  shopId             String?            @unique @db.ObjectId
  status             SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  currentPeriodStart DateTime           @default(now())
  currentPeriodEnd   DateTime
  amount             Int                @default(100000) // ₦1,000 in kobo
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  shop                Shop?                 @relation(fields: [shopId], references: [id], onDelete: Cascade)
  SubscriptionPayment SubscriptionPayment[]

  @@index([status])
}

model SubscriptionPayment {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId   String        @db.ObjectId
  reference        String        @unique
  amount           Int // Amount in kobo
  status           PaymentStatus @default(PENDING)
  paystackResponse Json?
  paidAt           DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([status])
}

// ============================================
// PRODUCTS & CATEGORIES
// ============================================

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
}

model Product {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  shopId         String?     @db.ObjectId
  categoryId     String?     @db.ObjectId
  name           String
  slug           String
  description    String?
  price          Int // Price in kobo (₦1 = 100 kobo)
  compare_price  Int? // Original price for discounts
  stock_quantity Int         @default(0)
  type           ProductType @default(PRODUCT)
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  shop       Shop?          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  category   Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images     ProductImage[]
  orderItems OrderItem[]
  reviews    Review[]

  @@unique([shopId, slug])
  @@index([shopId])
  @@index([categoryId])
  @@index([isActive])
  @@index([price])
}

model ProductImage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  url       String
  alt       String?
  position  Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber     String      @unique
  customerId      String?     @db.ObjectId
  shopId          String      @db.ObjectId
  status          OrderStatus @default(PENDING)
  subtotal        Int // Amount in kobo
  deliveryFee     Int         @default(0)
  total_amount    Int // Amount in kobo
  customerName    String
  customerEmail   String
  customerPhone   String
  deliveryAddress String
  deliveryCity    String
  deliveryState   String
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  customer User?       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  shop     Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  items    OrderItem[]
  payment  Payment?

  @@index([customerId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int
  price     Int // Price at time of order in kobo
  total     Int // quantity * price
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: NoAction)

  @@index([orderId])
  @@index([productId])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId          String        @unique @db.ObjectId
  reference        String        @unique
  amount           Int // Amount in kobo
  status           PaymentStatus @default(PENDING)
  paystackResponse Json?
  paidAt           DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
}

model RevenueTransaction {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  shopId            String?  @db.ObjectId
  orderId           String?  @db.ObjectId
  subscriptionId    String?  @db.ObjectId
  amount            Int
  currency          String   @default("NGN")
  payment_reference String?
  payment_method    String?
  transaction_type  String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  shop Shop? @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([orderId])
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  productId  String   @db.ObjectId
  customerId String   @db.ObjectId
  rating     Int // 1-5
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer User    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([productId, customerId]) // One review per customer per product
  @@index([productId])
  @@index([customerId])
  @@index([rating])
}

// ============================================
// OFFERS, COURSES, REWARDS
// ============================================

model Offer {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  title               String
  description         String?
  image_url           String?
  code                String?
  discount_percentage Int?
  target_audience     String?
  button_text         String?
  button_link         String?
  startDate           DateTime
  valid_until         DateTime
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([isActive])
  @@index([startDate, valid_until])
}

model DeadLetter {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  queue       String
  event       String?
  reference   String?
  payload     Json
  signature   String?
  error       String?
  attempts    Int       @default(0)
  lastErrorAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([attempts])
  @@index([createdAt])
  @@index([reference])
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  image_url   String?
  content     String? // Could be markdown or HTML
  duration    String? // e.g., "2 hours"
  level       String? // Beginner, Intermediate, Advanced
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isPublished])
}

model Reward {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?
  points_required Int      @default(0)
  image_url       String?
  stock_quantity  Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
}

// ============================================
// FEEDBACK
// ============================================

model Feedback {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  userId    String         @db.ObjectId
  subject   String
  message   String
  status    FeedbackStatus @default(PENDING)
  response  String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}
